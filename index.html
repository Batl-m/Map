<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<div id="map" style="width:100%;height:100vh"></div>

<script>
Telegram.WebApp.ready(); Telegram.WebApp.expand();

const params = new URLSearchParams(location.search);
const c = params.get('c') || "51.1694,71.4491,13";  // Астана по умолчанию
const [lat, lon, zoom] = c.split(',').map(Number);

const map = L.map('map').setView([lat, lon], zoom);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const marker = L.marker([lat, lon], {draggable: true}).addTo(map);
marker.bindPopup("Перетащите маркер").openPopup();

function send() {
    const p = marker.getLatLng();
    Telegram.WebApp.sendData(JSON.stringify({lat: p.lat.toFixed(6), lon: p.lng.toFixed(6)}));
}

marker.on('dragend', send);
map.on('click', e => { marker.setLatLng(e.latlng); send(); });

const btn = document.createElement('button');
btn.textContent = "Выбрать это место";
btn.style = "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:15px 40px;font-size:18px;background:#0088cc;color:white;border:none;border-radius:12px;z-index:1000;";
btn.onclick = send;
document.body.appendChild(btn);
</script>
