<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<div id="map" style="width:100%; height:100vh;"></div>

<script>
Telegram.WebApp.ready(); Telegram.WebApp.expand();

const urlParams = new URLSearchParams(location.search);
const lat = parseFloat(urlParams.get('lat')) || 55.7558;
const lon = parseFloat(urlParams.get('lon')) || 37.6173;
const zoom = parseInt(urlParams.get('zoom')) || 13;
const title = urlParams.get('title') || "Выберите место";

const map = L.map('map').setView([lat, lon], zoom);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const marker = L.marker([lat, lon], {draggable: true}).addTo(map);
marker.bindPopup(title).openPopup();

function send() {
    const {lat, lng} = marker.getLatLng();
    Telegram.WebApp.sendData(JSON.stringify({lat: lat.toFixed(6), lon: lng.toFixed(6)}));
}

marker.on('dragend', send);
map.on('click', e => { marker.setLatLng(e.latlng); send(); });

// Кнопка внизу
const btn = document.createElement('button');
btn.textContent = "Выбрать это место";
btn.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); padding:15px 30px; font-size:18px; background:#0088cc; color:white; border:none; border-radius:12px; z-index:1000;";
btn.onclick = send;
document.body.appendChild(btn);
</script>
